<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AR Advertisement Prototype - Three.js + MindAR</title>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.125.2/build/three.min.js"></script>

  <!-- MindAR Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: black; }
    #promo-video { display: none; }
    canvas { position: absolute; top: 0; left: 0; }
    #log {
      position: absolute; top: 10px; left: 10px;
      color: white; background: rgba(0,0,0,0.6);
      padding: 5px 10px; border-radius: 5px;
      font-family: monospace; z-index: 999;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div id="log">Waiting for target...</div>

  <!-- Video element -->
  <video id="promo-video" src="./sample-video.mp4" loop playsinline muted></video>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const logBox = document.getElementById("log");
      const log = (msg) => { 
        console.log(msg);
        logBox.innerText = msg;
      };

      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: "./targets.mind",
      });

      const {renderer, scene, camera} = mindarThree;
      const promoVideo = document.querySelector("#promo-video");

      // Video texture
      const texture = new THREE.VideoTexture(promoVideo);
      const geometry = new THREE.PlaneGeometry(2, 1.2); // Bigger plane to test
      const material = new THREE.MeshBasicMaterial({ 
        map: texture, 
        side: THREE.DoubleSide, 
        transparent: true, 
        opacity: 1 
      });
      const plane = new THREE.Mesh(geometry, material);

      const anchor = mindarThree.addAnchor(0);
      anchor.group.add(plane);

      await mindarThree.start();

      renderer.setAnimationLoop(() => {
        if (!promoVideo.paused && promoVideo.readyState >= 2) {
          texture.needsUpdate = true;
          log("Video running ðŸŽ¬ | Time: " + promoVideo.currentTime.toFixed(2) + "s");
        }
        renderer.render(scene, camera);
      });

      // Play when target found
      anchor.onTargetFound = async () => {
        log("Target Found âœ… - trying to play video...");
        try {
          await promoVideo.play();
          log("Video is playing ðŸŽ¬");
        } catch (err) {
          log("Autoplay blocked ðŸš« - tap screen to start");
          document.body.addEventListener("click", () => {
            promoVideo.play();
            log("Video started after tap ðŸŽ¬");
          }, {once: true});
        }
      };

      // Pause when lost
      anchor.onTargetLost = () => {
        log("Target Lost â›” - video paused");
        promoVideo.pause();
      };
    });
  </script>
</body>
</html>
